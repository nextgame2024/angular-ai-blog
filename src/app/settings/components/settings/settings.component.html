<ng-container *ngIf="data$ | async as data">
  <div *ngIf="currentUser" class="container mx-auto px-4 py-6">
    <div class="max-w-2xl mx-auto">
      <p-card class="shadow-sm">
        <!-- Header aligned to body padding -->
        <ng-template pTemplate="header">
          <div class="flex items-center justify-between px-5 pt-5 pb-2">
            <h2 class="text-2xl font-bold">Settings</h2>
            <button
              pButton
              label="Log out"
              class="p-button-outlined p-button-danger"
              (click)="logout()"
            ></button>
          </div>
        </ng-template>

        <!-- Preview row: bigger avatar on the left, Upload on the right -->
        <div class="flex items-center justify-between gap-6 mb-4 px-5">
          <!-- Larger, cropped, keeps aspect ratio -->
          <img
            [src]="previewUrl || form.value.image || defaultAvatar"
            alt="profile picture"
            class="h-28 w-28 rounded-full object-cover"
            referrerpolicy="no-referrer"
          />

          <!-- Upload button to the right -->
          <p-fileUpload
            #uploader
            name="avatar"
            mode="basic"
            [auto]="true"
            [customUpload]="true"
            [maxFileSize]="5_000_000"
            accept="image/*"
            chooseLabel="Upload"
            (onSelect)="onFileSelected($event)"
            (uploadHandler)="onUpload($event)"
            [disabled]="data.isSubmitting || !!(isUploadingAvatar$ | async)"
          ></p-fileUpload>
        </div>

        <p class="text-xs text-gray-400 px-5 -mt-2 mb-2">
          PNG/JPG/WebP, up to 5 MB. Weâ€™ll upload and replace your profile
          picture.
        </p>

        <mc-backend-error-messages
          *ngIf="data.backendErrors"
          [backendErrors]="data.backendErrors"
          class="px-5"
        ></mc-backend-error-messages>

        <form
          [formGroup]="form"
          (ngSubmit)="submit()"
          class="space-y-4 mt-2 px-5 pb-5"
        >
          <!-- Username -->
          <div class="p-inputgroup w-full">
            <span class="p-inputgroup-addon"><i class="pi pi-user"></i></span>
            <input
              pInputText
              type="text"
              formControlName="username"
              placeholder="Username"
              class="w-full"
            />
          </div>

          <!-- Bio -->
          <textarea
            pInputTextarea
            formControlName="bio"
            rows="4"
            placeholder="Short bio about you"
            class="w-full"
          ></textarea>

          <!-- Email -->
          <div class="p-inputgroup w-full">
            <span class="p-inputgroup-addon"
              ><i class="pi pi-envelope"></i
            ></span>
            <input
              pInputText
              type="email"
              formControlName="email"
              placeholder="Email"
              class="w-full"
            />
          </div>

          <!-- Password -->
          <div class="p-inputgroup w-full">
            <span class="p-inputgroup-addon"><i class="pi pi-lock"></i></span>
            <div class="flex-1 min-w-0">
              <p-password
                formControlName="password"
                [feedback]="false"
                [toggleMask]="true"
                styleClass="block w-full"
                [style]="{ width: '100%' }"
                inputStyleClass="w-full"
                [inputStyle]="{ width: '100%' }"
                placeholder="New password"
              ></p-password>
            </div>
          </div>

          <button
            pButton
            type="submit"
            label="Update settings"
            class="w-full md:w-full"
            [disabled]="
              form.invalid ||
              data.isSubmitting ||
              !!(isUploadingAvatar$ | async)
            "
          ></button>
        </form>
      </p-card>
    </div>
  </div>
</ng-container>
