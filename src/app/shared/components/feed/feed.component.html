<ng-container *ngIf="data$ | async as data">
  <mc-loading *ngIf="data.isLoading"></mc-loading>
  <mc-error-message
    *ngIf="data.error"
    [message]="data.error"
  ></mc-error-message>

  <div *ngIf="data.feed">
    <p-card *ngIf="data.feed.articlesCount === 0" class="shadow-sm mb-4">
      <ng-container *ngIf="isYourFeed; else nonPersonal">
        <div class="flex flex-wrap items-center justify-between gap-2 mb-1">
          <p class="font-medium">Your feed is empty</p>

          <div class="flex items-center gap-2 ml-auto">
            <a routerLink="/" class="p-button p-button-text p-button-sm">
              Browse Global feed
            </a>
            <a
              routerLink="/tag/content-ai"
              class="p-button p-button-text p-button-sm"
            >
              Explore tags
            </a>
          </div>
        </div>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
          Follow some authors to see their latest posts here.
        </p>
        <div class="mt-4">
          <mc-suggested-authors
            (refreshTrigger)="onSuggestionsRefresh()"
          ></mc-suggested-authors>
        </div>
      </ng-container>

      <ng-template #nonPersonal>
        <ng-container *ngIf="isTagFeed; else globalEmpty">
          <p class="font-medium mb-1">
            No articles for <span class="font-semibold">#{{ currentTag }}</span>
          </p>
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
            Try another tag or check the global feed.
          </p>
          <a routerLink="/" class="p-button p-button-text p-button-sm">
            Go to Global feed
          </a>
        </ng-container>

        <ng-template #globalEmpty>
          <p class="font-medium mb-1">No articles yet</p>
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
            Try filtering by a tag, or check back later.
          </p>
          <a
            routerLink="/tag/content-ai"
            class="p-button p-button-text p-button-sm"
          >
            Explore tags
          </a>
        </ng-template>
      </ng-template>
    </p-card>

    <div class="space-y-4">
      <p-card *ngFor="let article of data.feed.articles" class="shadow-sm">
        <!-- header: avatar, author, date, favorite -->
        <div class="flex items-center gap-3">
          <a
            [routerLink]="['/profiles', article.author.username]"
            class="shrink-0"
          >
            <img
              class="w-10 h-10 rounded-full object-cover"
              [src]="article.author.image || defaultAvatar"
              [alt]="article.author.username + ' avatar'"
              (error)="setFallback($event)"
            />
          </a>

          <div class="min-w-0">
            <a
              [routerLink]="['/profiles', article.author.username]"
              class="block font-medium truncate"
            >
              {{ article.author.username }}
            </a>
            <span class="text-sm text-gray-500">
              {{ article.createdAt | date : "mediumDate" }}
            </span>
          </div>

          <div class="ml-auto">
            <mc-add-to-favorites
              [isFavorited]="article.favorited"
              [articleSlug]="article.slug"
              [favoritesCount]="article.favoritesCount"
            >
            </mc-add-to-favorites>
          </div>
        </div>

        <!-- 1-col on mobile, 2-cols on md+ -->
        <div class="mt-3 grid grid-cols-1 md:grid-cols-5 gap-3 md:gap-4">
          <!-- LEFT: media (video / image / audio / placeholder) -->
          <div class="md:col-span-2">
            <mc-article-media [assets]="article.assets"></mc-article-media>
          </div>

          <!-- RIGHT: text content -->
          <div class="md:col-span-3">
            <a [routerLink]="['/articles', article.slug]" class="block">
              <h2 class="text-lg md:text-xl font-semibold leading-snug">
                {{ article.title }}
              </h2>
              <p class="text-gray-600 mt-1 line-clamp-3">
                {{ article.description }}
              </p>
            </a>

            <!-- footer: tags + read more -->
            <div class="mt-3 flex flex-wrap items-center justify-between gap-3">
              <mc-tag-list [tags]="article.tagList"></mc-tag-list>

              <a
                [routerLink]="['/articles', article.slug]"
                pButton
                label="Read more"
                class="p-button-text p-button-sm"
              >
              </a>
            </div>
          </div>
        </div>
      </p-card>
    </div>

    <!-- pagination -->
    <div class="mt-6">
      <mc-pagination
        [total]="data.feed.articlesCount"
        [limit]="limit"
        [url]="baseUrl"
        [currentPage]="currentPage"
      >
      </mc-pagination>
    </div>
  </div>
</ng-container>
