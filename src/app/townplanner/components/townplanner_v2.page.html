<!-- src/app/townplanner/components/townplanner_v2.page.html -->
<div class="tp2-shell">
  <!-- Map -->
  <div class="tp2-map">
    <ng-container *ngIf="mapsLoaded; else mapFallback">
      <google-map
        class="tp2-google-map"
        [center]="mapCenter"
        [zoom]="mapZoom"
        [options]="mapOptions"
        width="100%"
        height="100%"
      >
        <map-marker
          *ngIf="markerPosition"
          [position]="markerPosition"
        ></map-marker>

        <map-polygon
          *ngIf="polygonPaths?.length"
          [paths]="polygonPaths"
          [options]="polygonOptions"
        ></map-polygon>
      </google-map>
    </ng-container>

    <ng-template #mapFallback>
      <div class="tp2-map-fallback">
        <div class="tp2-map-fallback-inner">
          <div class="tp2-map-fallback-title">Map unavailable</div>
          <div class="tp2-map-fallback-text" *ngIf="mapsError; else mapLoading">
            {{ mapsError }}
          </div>
        </div>
        <ng-template #mapLoading>Loading map…</ng-template>
      </div>
    </ng-template>
  </div>

  <!-- Search Bar (no Search button; selection triggers the flow) -->
  <div class="tp2-search" role="search">
    <i class="pi pi-search tp2-search-icon" aria-hidden="true"></i>

    <div class="tp2-search-field">
      <input
        class="tp2-search-input"
        type="text"
        [formControl]="addressCtrl"
        placeholder="Enter property address"
        aria-label="Enter property address"
        (focus)="onInputFocus()"
        (blur)="onInputBlur()"
        (keydown)="onInputKeydown($event)"
      />

      <div
        class="tp2-suggest"
        *ngIf="showSuggestions && (suggestions$ | async)?.length"
      >
        <button
          type="button"
          class="tp2-suggest-item"
          *ngFor="let s of (suggestions$ | async); let i = index"
          [class.is-active]="i === activeIndex"
          (mousedown)="onSuggestionMouseDown(s)"
        >
          {{ s.description }}
        </button>
      </div>
    </div>
  </div>

  <!-- Right / Bottom Panel -->
  <aside
    class="tp2-panel"
    [class.is-collapsed]="panelCollapsed"
    [class.is-mobile]="isMobile"
  >
    <button
      type="button"
      class="tp2-panel-toggle"
      (click)="togglePanel()"
      [attr.aria-label]="panelCollapsed ? 'Open panel' : 'Close panel'"
    >
      {{ panelArrow() }}
    </button>

    <div class="tp2-panel-inner">
      <div class="tp2-panel-title">Property Report</div>

      <div class="tp2-panel-body">
        <ng-container *ngIf="(selected$ | async) as selected; else emptyState">
          <!-- Property photo -->
          <img
            class="tp2-property-photo"
            [src]="streetViewPhotoUrl(selected)"
            [alt]="selected.address || 'Selected property'"
            (error)="onPhotoError($event)"
          />

          <!-- Address label -->
          <div class="tp2-panel-text tp2-selected-address">
            {{ selected.address || 'Selected property' }}
          </div>

          <!-- Panel 1: Report button (no action for now) -->
          <section class="tp2-card">
            <div class="tp2-card-title">GET YOUR FREE REPORT</div>
            <button type="button" class="tp2-report-btn" disabled>
              CREATE REPORT
            </button>
          </section>

          <!-- Panel 2: Property Overview (display only, no action for now) -->
          <section class="tp2-card">
            <div class="tp2-card-head">
              <div class="tp2-card-head-title">Property Overview</div>
              <span class="tp2-card-chevron" aria-hidden="true">˄</span>
            </div>

            <div class="tp2-overview-grid">
              <div class="tp2-overview-item">
                <div class="tp2-overview-icon">
                  <i class="pi pi-building"></i>
                </div>
                <div class="tp2-overview-k">LOCAL COUNCIL:</div>
                <div class="tp2-overview-v">Brisbane City Council</div>
              </div>

              <div class="tp2-overview-item">
                <div class="tp2-overview-icon">
                  <i class="pi pi-map"></i>
                </div>
                <div class="tp2-overview-k">PLANNING SCHEME:</div>
                <div class="tp2-overview-v">
                  Brisbane City Plan 2014 (v35.00) – MAPPING ERROR
                </div>
              </div>

              <div class="tp2-overview-item">
                <div class="tp2-overview-icon">
                  <i class="pi pi-table"></i>
                </div>
                <div class="tp2-overview-k">PROPERTY DIMENSIONS:</div>
                <div class="tp2-overview-v">Total Area: 0 sqm</div>
                <div class="tp2-overview-v">Total Frontage: 0 m</div>
              </div>
            </div>
          </section>
        </ng-container>

        <ng-template #emptyState>
          <div class="tp2-panel-text">
            Please enter an address in the search bar
          </div>
          <div class="tp2-footer">© sophiaAi 2026. All rights reserved</div>
        </ng-template>
      </div>
    </div>
  </aside>
</div>
